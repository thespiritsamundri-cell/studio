rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function getPermissions() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.permissions;
    }

    function isSuperAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin';
    }

    // Allow user to read their own user document to get their permissions
    match /users/{userId} {
      allow read: if request.auth.uid == userId;
      // Allow super admin to manage all user documents
      allow write, list: if isSuperAdmin();
    }

    // Allow any authenticated user to read the main settings document
    match /Settings/{docId} {
       allow get: if request.auth.uid != null;
       allow list, write: if isSuperAdmin() || getPermissions().settings == true;
    }
    
    match /branding/{docId} {
       allow read: if request.auth.uid != null;
       allow write: if isSuperAdmin() || getPermissions().settings == true;
    }

    match /students/{docId} {
      allow list, read: if isSuperAdmin() || getPermissions().students == true || getPermissions().admissions == true || getPermissions().dashboard == true;
      allow write: if isSuperAdmin() || getPermissions().students == true || getPermissions().admissions == true;
    }

    match /families/{docId} {
      allow list, read: if isSuperAdmin() || getPermissions().families == true || getPermissions().admissions == true || getPermissions().students == true || getPermissions().feeCollection == true;
      allow write: if isSuperAdmin() || getPermissions().families == true;
    }

    match /fees/{docId} {
      allow list, read: if isSuperAdmin() || getPermissions().feeCollection == true || getPermissions().income == true || getPermissions().accounts == true;
      allow write: if isSuperAdmin() || getPermissions().feeCollection == true || getPermissions().income == true;
    }
    
    match /expenses/{docId} {
      allow list, read: if isSuperAdmin() || getPermissions().expenses == true || getPermissions().accounts == true;
      allow write: if isSuperAdmin() || getPermissions().expenses == true;
    }

    match /teachers/{docId} {
      allow list, read, write: if isSuperAdmin() || getPermissions().teachers == true;
    }
    
    match /teacherAttendances/{docId} {
      allow list, read, write: if isSuperAdmin() || getPermissions().attendance == true;
    }

    match /classes/{docId} {
      allow list, read: if request.auth.uid != null; // Allow all authenticated users to read classes
      allow write: if isSuperAdmin() || getPermissions().classes == true;
    }

    match /exams/{docId} {
      allow list, read: if isSuperAdmin() || getPermissions().examSystem == true || getPermissions().accountant == true || getPermissions().coordinator == true;
      allow write: if isSuperAdmin() || getPermissions().examSystem == true;
    }
    
    match /attendances/{docId} {
       allow list, read, write: if isSuperAdmin() || getPermissions().attendance == true;
    }
    
    match /timetables/{docId} {
      allow list, read: if isSuperAdmin() || getPermissions().timetable == true || getPermissions().accountant == true || getPermissions().coordinator == true;
      allow write: if isSuperAdmin() || getPermissions().timetable == true;
    }

    match /alumni/{docId} {
      allow list, read: if isSuperAdmin() || getPermissions().alumni == true || getPermissions().accountant == true || getPermissions().coordinator == true;
      allow write: if isSuperAdmin() || getPermissions().alumni == true;
    }
    
    match /activityLog/{docId} {
       allow list, read, write: if isSuperAdmin() || getPermissions().settings == true;
    }
    
    match /sessions/{docId} {
      allow read: if request.auth.uid != null;
      allow delete: if request.auth.uid != null;
      allow create: if request.auth.uid != null;
    }
  }
}
