rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // -------------------------
    // Helper function to get role & permissions from the user's own document
    // -------------------------
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function getRole() {
      return getUserData().role;
    }

    function getPermissions() {
      return getUserData().permissions;
    }

    // -------------------------
    // Users
    // Allow users to read their own profile to get roles/permissions.
    // Super admin can list and write to all user docs.
    // -------------------------
    match /users/{userId} {
      allow read: if request.auth.uid == userId;
      allow write: if getRole() == "super_admin";
      allow list: if getRole() == "super_admin";
    }

    // -------------------------
    // Students
    // -------------------------
    match /students/{docId} {
      allow list, read: if getRole() in ["super_admin", "accountant", "coordinator"] || getPermissions().students == true;
      allow write: if getRole() == "super_admin" || getPermissions().students == true;
    }

    // -------------------------
    // Families
    // -------------------------
     match /families/{docId} {
      allow list, read: if getRole() in ["super_admin", "accountant", "coordinator"] || getPermissions().families == true;
      allow write: if getRole() == "super_admin" || getPermissions().families == true;
    }

    // -------------------------
    // Teachers
    // -------------------------
    match /teachers/{docId} {
      allow list, read: if getRole() in ["super_admin", "accountant", "coordinator"] || getPermissions().teachers == true;
      allow write: if getRole() == "super_admin" || getPermissions().teachers == true;
    }

    // -------------------------
    // Classes
    // -------------------------
    match /classes/{docId} {
       allow list, read: if getRole() in ["super_admin", "accountant", "coordinator"] || getPermissions().classes == true;
       allow write: if getRole() == "super_admin" || getPermissions().classes == true;
    }
    
    // -------------------------
    // Timetable
    // -------------------------
    match /timetables/{docId} {
       allow list, read: if getRole() in ["super_admin", "accountant", "coordinator"] || getPermissions().timetable == true;
       allow write: if getRole() == "super_admin" || getPermissions().timetable == true;
    }
    
    // -------------------------
    // Attendance
    // -------------------------
     match /attendances/{docId} {
      allow list, read: if getRole() in ["super_admin", "accountant", "coordinator"] || getPermissions().attendance == true;
      allow write: if getRole() == "super_admin" || getPermissions().attendance == true;
    }
    
    match /teacherAttendances/{docId} {
      allow list, read: if getRole() in ["super_admin", "accountant", "coordinator"] || getPermissions().attendance == true;
      allow write: if getRole() == "super_admin" || getPermissions().attendance == true;
    }

    // -------------------------
    // Exams
    // -------------------------
    match /exams/{docId} {
      allow list, read: if getRole() in ["super_admin", "accountant", "coordinator"] || getPermissions().examSystem == true;
      allow write: if getRole() == "super_admin" || getPermissions().examSystem == true;
    }
    
    // -------------------------
    // Alumni
    // -------------------------
    match /alumni/{docId} {
       allow list, read: if getRole() in ["super_admin", "accountant", "coordinator"] || getPermissions().alumni == true;
       allow write: if getRole() == "super_admin" || getPermissions().alumni == true;
    }

    // -------------------------
    // Finance (Fees, Expenses, Accounts)
    // -------------------------
    match /fees/{docId} {
      allow list, read, write: if getRole() in ["super_admin", "accountant"] || getPermissions().feeCollection == true;
    }
    
    match /expenses/{docId} {
       allow list, read, write: if getRole() in ["super_admin", "accountant"] || getPermissions().expenses == true;
    }

    // -------------------------
    // Admin & System Collections
    // -------------------------
    match /activityLog/{docId} {
       allow read, write: if request.auth != null; // Allow any authenticated user
    }
    
    match /sessions/{docId} {
       allow read, write: if request.auth != null; // Allow any authenticated user
    }
    
    match /Settings/{docId} {
      allow read: if request.auth != null;
      allow write: if getRole() == "super_admin" || getPermissions().settings == true;
    }

    match /branding/{docId} {
        allow read: if true; // Publicly readable for logos/branding
        allow write: if getRole() == "super_admin" || getPermissions().settings == true;
    }
  }
}
