
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to get the role of the requesting user.
    function getRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    // Helper function to get the permissions of the requesting user.
    function getPermissions() {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.permissions;
    }

    // -------------------------
    // Users Collection
    // -------------------------
    match /users/{userId} {
      // ANY authenticated user can READ THEIR OWN document. This is key.
      allow read: if request.auth.uid == userId;
      // ONLY a super_admin can read ALL user documents.
      allow list, write: if getRole() == 'super_admin';
    }

    // -------------------------
    // Students Collection
    // -------------------------
    match /students/{docId} {
      allow list, read: if getRole() == 'super_admin' || getPermissions().students == true;
      allow write: if getRole() == 'super_admin' || getPermissions().admissions == true;
    }
    
    // -------------------------
    // Alumni Collection
    // -------------------------
    match /alumni/{docId} {
      allow list, read, write: if getRole() == 'super_admin' || getPermissions().alumni == true;
    }

    // -------------------------
    // Families Collection
    // -------------------------
    match /families/{docId} {
      allow list, read, write: if getRole() == 'super_admin' || getPermissions().families == true;
    }
    
    // -------------------------
    // Teachers Collection
    // -------------------------
    match /teachers/{docId} {
        allow list, read, write: if getRole() == 'super_admin' || getPermissions().teachers == true;
    }

    // -------------------------
    // Classes Collection
    // -------------------------
    match /classes/{docId} {
       allow list, read, write: if getRole() == 'super_admin' || getPermissions().classes == true;
    }

    // -------------------------
    // Attendance Collections
    // -------------------------
    match /attendances/{docId} {
      allow list, read, write: if getRole() == 'super_admin' || getPermissions().attendance == true;
    }
    match /teacherAttendances/{docId} {
      allow list, read, write: if getRole() == 'super_admin' || getPermissions().attendance == true;
    }
    
    // -------------------------
    // Exam System Collections
    // -------------------------
     match /exams/{docId} {
      allow list, read, write: if getRole() == 'super_admin' || getPermissions().examSystem == true;
    }
    
     match /timetables/{docId} {
      allow list, read, write: if getRole() == 'super_admin' || getPermissions().timetable == true;
    }

    // -------------------------
    // Financial Collections
    // -------------------------
    match /fees/{docId} {
      allow list, read, write: if getRole() == 'super_admin' || getPermissions().feeCollection == true || getPermissions().income == true;
    }
    
    match /expenses/{docId} {
        allow list, read, write: if getRole() == 'super_admin' || getPermissions().expenses == true;
    }

    // -------------------------
    // Admin & System Collections
    // -------------------------
    match /Settings/{docId} {
      allow list, read: if request.auth != null; // All authenticated users can read settings
      allow write: if getRole() == 'super_admin';
    }
    
     match /branding/{docId} {
      allow list, read: if request.auth != null; // All authenticated users can read branding assets
      allow write: if getRole() == 'super_admin';
    }

    match /activityLog/{docId} {
      allow list, read, write: if getRole() == 'super_admin';
    }
    
    match /sessions/{docId} {
        allow read: if request.auth.uid == get(/databases/$(database)/documents/sessions/$(docId)).data.userId;
        allow list, write, delete: if getRole() == 'super_admin';
    }
  }
}
