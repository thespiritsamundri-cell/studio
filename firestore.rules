
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    function isSuperAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin';
    }

    function hasPermission(permission) {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.permissions[permission] == true;
    }
    
    // Default Read Access: Allow any authenticated user to read documents.
    // Write access is handled by more specific rules below.
    match /{document=**} {
      allow read: if request.auth != null;
    }

    // User Management
    match /users/{userId} {
      // Allow users to get their own document, and super admin to manage all.
      allow get: if request.auth != null;
      allow list, write, delete: if isSuperAdmin();
    }
    
    // Students & Alumni
    match /students/{studentId} {
      allow write, delete: if isSuperAdmin() || hasPermission('students');
    }
    
    match /alumni/{alumniId} {
      allow write, delete: if isSuperAdmin() || hasPermission('alumni');
    }
    
    // Families
    match /families/{familyId} {
       allow write, delete: if isSuperAdmin() || hasPermission('families');
    }

    // Fees
    match /fees/{feeId} {
      // Allow creation if user can collect fees or manage income.
      allow create: if isSuperAdmin() || hasPermission('feeCollection') || hasPermission('income');
      // Allow update/delete if user can collect fees OR manage income.
      allow update, delete: if isSuperAdmin() || hasPermission('feeCollection') || hasPermission('income');
    }

    // Teachers
    match /teachers/{teacherId} {
      allow write, delete: if isSuperAdmin() || hasPermission('teachers');
    }

    // Attendance
    match /attendances/{attendanceId} {
        allow write: if isSuperAdmin() || hasPermission('attendance');
    }
    
    match /teacherAttendances/{attendanceId} {
        allow write: if isSuperAdmin() || hasPermission('attendance');
    }

    // Classes
    match /classes/{classId} {
      allow write, delete: if isSuperAdmin() || hasPermission('classes');
    }

    // Exams
    match /exams/{examId} {
      allow write, delete: if isSuperAdmin() || hasPermission('examSystem');
    }

    // Expenses
    match /expenses/{expenseId} {
      allow write, delete: if isSuperAdmin() || hasPermission('expenses');
    }

    // Timetables
    match /timetables/{timetableId} {
        allow write: if isSuperAdmin() || hasPermission('timetable');
    }

    // Settings & Branding - Only Super Admin can write
    match /Settings/{docId} {
        allow write: if isSuperAdmin();
    }
     match /branding/{docId} {
        allow write: if isSuperAdmin();
    }

    // ActivityLog
    match /activityLog/{logId} {
      allow create: if request.auth != null; // Any authenticated user can create a log of their own actions.
      allow delete: if isSuperAdmin(); // Only super admin can delete.
    }
    
    // Notifications: Any primary user can create, only super admin can read/update.
    match /notifications/{notificationId} {
        allow create: if request.auth != null;
        allow read, update, delete: if isSuperAdmin();
    }
    
    // Sessions: Any primary user can read, only super admin can delete others' sessions.
    match /sessions/{sessionId} {
      allow get: if request.auth != null;
      allow list: if isSuperAdmin();
      allow create: if request.auth.uid == resource.data.userId;
      allow update: if request.auth.uid == resource.data.userId;
      allow delete: if isSuperAdmin() || request.auth.uid == resource.data.userId;
    }
  }
}
