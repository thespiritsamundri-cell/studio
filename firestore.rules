rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to get the current user's permissions object
    function getUserPermissions() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.permissions;
    }
    
    // Helper function to check if the user is a super_admin
    function isSuperAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin';
    }

    // ------------------------------------------------------------------
    //  USERS COLLECTION
    //  - Allow users to read their own document to get their permissions.
    //  - Only super_admin can list, create, or update users.
    // ------------------------------------------------------------------
    match /users/{userId} {
      allow read: if request.auth.uid == userId;
      allow list, write: if isSuperAdmin();
    }

    // ------------------------------------------------------------------
    //  GENERAL & ACADEMIC COLLECTIONS
    //  - Accessible by super_admin and users with specific permission flags.
    // ------------------------------------------------------------------
    match /students/{docId} {
      allow list, read, write: if isSuperAdmin() || getUserPermissions().students == true;
    }
    match /families/{docId} {
      allow list, read, write: if isSuperAdmin() || getUserPermissions().families == true;
    }
    match /admissions/{docId} {
       allow list, read, write: if isSuperAdmin() || getUserPermissions().admissions == true;
    }
    match /classes/{docId} {
      allow list, read, write: if isSuperAdmin() || getUserPermissions().classes == true;
    }
    match /teachers/{docId} {
      allow list, read, write: if isSuperAdmin() || getUserPermissions().teachers == true;
    }
    match /timetable/{docId} {
        allow list, read, write: if isSuperAdmin() || getUserPermissions().timetable == true;
    }
    match /attendances/{docId} {
      allow list, read, write: if isSuperAdmin() || getUserPermissions().attendance == true;
    }
    match /teacherAttendances/{docId} {
      allow list, read, write: if isSuperAdmin() || getUserPermissions().attendance == true;
    }
    match /exams/{docId} {
      allow list, read, write: if isSuperAdmin() || getUserPermissions().examSystem == true;
    }
    match /alumni/{docId} {
        allow list, read, write: if isSuperAdmin() || getUserPermissions().alumni == true;
    }
     match /yearbook/{docId} {
        allow list, read, write: if isSuperAdmin() || getUserPermissions().yearbook == true;
    }
    
    // ------------------------------------------------------------------
    //  FINANCIAL COLLECTIONS
    //  - Accessible by super_admin and users with finance permissions.
    // ------------------------------------------------------------------
    match /fees/{docId} {
      allow list, read, write: if isSuperAdmin() || getUserPermissions().feeCollection == true;
    }
     match /vouchers/{docId} {
      allow list, read, write: if isSuperAdmin() || getUserPermissions().feeVouchers == true;
    }
    match /income/{docId} {
      allow list, read, write: if isSuperAdmin() || getUserPermissions().income == true;
    }
    match /expenses/{docId} {
      allow list, read, write: if isSuperAdmin() || getUserPermissions().expenses == true;
    }
    match /accounts/{docId} {
        allow list, read, write: if isSuperAdmin() || getUserPermissions().accounts == true;
    }
    
    // ------------------------------------------------------------------
    //  ADMIN & LOGGING COLLECTIONS
    // ------------------------------------------------------------------
    match /reports/{docId} {
      allow list, read, write: if isSuperAdmin() || getUserPermissions().reports == true;
    }
    match /archived/{docId} {
      allow list, read, write: if isSuperAdmin() || getUserPermissions().archived == true;
    }
    match /settings/{docId} {
      allow list, read, write: if isSuperAdmin() || getUserPermissions().settings == true;
    }
    match /branding/{docId} {
        allow read: if request.auth != null;
        allow write: if isSuperAdmin();
    }
    match /activityLog/{docId} {
      // Allow any authenticated user to write their own logs, but only super_admin can read/list all.
      allow create: if request.auth != null;
      allow list, read, delete: if isSuperAdmin();
    }
    match /sessions/{docId} {
      allow read, delete: if isSuperAdmin();
      allow create: if request.auth != null;
      allow update: if request.auth.uid == resource.data.userId;
    }
  }
}
