rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // -------------------------
    // Helper function to get role
    // -------------------------
    function getRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    // Allow users to read their own profile to determine their role
    match /users/{userId} {
      allow read: if request.auth.uid == userId;
      allow list, write: if getRole() == "super_admin";
    }

    // -------------------------
    // Students
    // -------------------------
    match /students/{docId} {
      allow list, read, write: if getRole() in ["super_admin", "coordinator"];
    }

    // -------------------------
    // Teachers
    // -------------------------
    match /teachers/{docId} {
      allow list, read, write: if getRole() in ["super_admin", "coordinator"];
    }

    // -------------------------
    // Classes
    // -------------------------
    match /classes/{docId} {
      allow list, read: if getRole() in ["super_admin", "coordinator", "accountant"];
      allow write: if getRole() in ["super_admin", "coordinator"];
    }

    // -------------------------
    // Fees (part of accounts)
    // -------------------------
     match /fees/{docId} {
      allow list, read, write: if getRole() in ["super_admin", "accountant"];
    }
    
    // -------------------------
    // Expenses (part of accounts)
    // -------------------------
     match /expenses/{docId} {
      allow list, read, write: if getRole() in ["super_admin", "accountant"];
    }

    // -------------------------
    // Reports
    // -------------------------
    match /reports/{docId} {
      allow read: if getRole() == "super_admin" ||
                   (getRole() == "accountant" && resource.data.type == "finance") ||
                   (getRole() == "coordinator" && resource.data.type == "academic");
      allow write: if getRole() == "super_admin";
    }

    // -------------------------
    // Attendance
    // -------------------------
    match /attendances/{docId} {
      allow list, read, write: if getRole() in ["super_admin", "coordinator"];
    }
    
     match /teacherAttendances/{docId} {
      allow list, read, write: if getRole() in ["super_admin", "coordinator"];
    }

    // -------------------------
    // Exams
    // -------------------------
    match /exams/{docId} {
      allow list, read, write: if getRole() in ["super_admin", "coordinator"];
    }
    
    // -------------------------
    // Alumni
    // -------------------------
     match /alumni/{docId} {
      allow list, read, write: if getRole() in ["super_admin", "coordinator"];
    }

    // -------------------------
    // Settings - Only Super Admin
    // -------------------------
    match /Settings/{docId} {
      allow read, write: if getRole() == "super_admin";
    }

    // -------------------------
    // Timetables
    // -------------------------
     match /timetables/{docId} {
      allow list, read, write: if getRole() in ["super_admin", "coordinator"];
    }
    
    // -------------------------
    // Activity Log
    // -------------------------
    match /activityLog/{docId} {
        allow list, read, write: if getRole() == "super_admin";
    }
    
    // -------------------------
    // Families
    // -------------------------
    match /families/{docId} {
        allow list, read, write: if getRole() in ["super_admin", "coordinator", "accountant"];
    }
    
    // -------------------------
    // Sessions - Only Super Admin for list, user can delete their own
    // -------------------------
    match /sessions/{docId} {
        allow list, read: if getRole() == "super_admin";
        allow delete: if request.auth.uid == resource.data.userId || getRole() == "super_admin";
        allow create: if request.auth.uid == request.resource.data.userId;
    }
    
    // -------------------------
    // Branding - Read for all
    // -------------------------
    match /branding/{docId} {
      allow read: if request.auth != null;
      allow write: if getRole() == "super_admin";
    }
  }
}
