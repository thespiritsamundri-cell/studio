
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to get the user's permissions map
    function getPermissions() {
      // Use exists() to handle cases where the user doc might not exist yet
      if (exists(/databases/$(database)/documents/users/$(request.auth.uid))) {
        return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.permissions;
      }
      return {}; // Return empty map if user doc doesn't exist
    }

    // Allow users to read their own user document to get their permissions
    // This is the key to breaking the permission "catch-22"
    match /users/{userId} {
      allow read: if request.auth.uid == userId;
      // Only super_admin can list all users or write to any user document
      allow list, write: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin';
    }
    
    // Allow read access based on the 'dashboard' permission
    match /students/{docId} {
      allow list, read, write: if getPermissions().students == true || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin';
    }
    match /families/{docId} {
        allow list, read, write: if getPermissions().families == true || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin';
    }
    match /fees/{docId} {
        allow list, read, write: if getPermissions().feeCollection == true || getPermissions().income == true || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin';
    }
     match /teachers/{docId} {
      allow list, read, write: if getPermissions().teachers == true || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin';
    }
     match /alumni/{docId} {
      allow list, read, write: if getPermissions().alumni == true || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin';
    }
    match /attendances/{docId} {
       allow list, read, write: if getPermissions().attendance == true || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin';
    }
    match /teacherAttendances/{docId} {
       allow list, read, write: if getPermissions().attendance == true || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin';
    }
    match /classes/{docId} {
      allow list, read, write: if getPermissions().classes == true || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin';
    }
    match /exams/{docId} {
      // FIX: Accountants and Coordinators need read access to populate reports/views. Write access remains restricted.
      allow list, read: if getPermissions().examSystem == true || getPermissions().reports == true || getPermissions().accounts == true || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin';
      allow write: if getPermissions().examSystem == true || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin';
    }
     match /expenses/{docId} {
        allow list, read, write: if getPermissions().expenses == true || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin';
    }
    match /timetables/{docId} {
        allow list, read, write: if getPermissions().timetable == true || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin';
    }
    match /activityLog/{docId} {
       allow list, read, write: if getPermissions().settings == true || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin';
    }
     match /sessions/{docId} {
       allow list, read, delete: if getPermissions().settings == true || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin';
       allow create: if request.auth != null;
    }
     match /Settings/{docId} {
       allow list, read, write: if getPermissions().settings == true || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin';
    }
     match /branding/{docId} {
       allow list, read, write: if getPermissions().settings == true || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super_admin';
    }
  }
}
