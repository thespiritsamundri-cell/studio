
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to get the role of the currently authenticated user.
    function getRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    // --- Users Collection ---
    // A user can read their own document to get their role.
    // Only a super_admin can write/create/delete user documents.
    match /users/{userId} {
      allow read: if request.auth.uid == userId;
      allow list, write: if getRole() == 'super_admin';
    }

    // --- Academic Collections ---
    // Accessed by super_admin and coordinator.
    match /{collection}/{docId} 
    where collection in ['students', 'teachers', 'classes', 'alumni', 'attendance', 'teacherAttendances', 'exams', 'timetables'] {
      allow read, write: if getRole() in ['super_admin', 'coordinator'];
    }

    // --- Financial Collections ---
    // Accessed by super_admin and accountant.
    match /{collection}/{docId} 
    where collection in ['families', 'fees', 'expenses'] {
      allow read, write: if getRole() in ['super_admin', 'accountant'];
    }
    
    // --- Settings & Logs ---
    // Accessed only by super_admin.
    match /{collection}/{docId} 
    where collection in ['Settings', 'activityLog', 'archived', 'sessions'] {
        allow read, write: if getRole() == 'super_admin';
    }
    
    // Allow any authenticated user to read branding assets
    match /branding/{docId} {
        allow read: if request.auth != null;
        allow write: if getRole() == 'super_admin';
    }
  }
}
