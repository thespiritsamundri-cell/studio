rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to get the user's role
    function getRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    // Users can read their own profile, but only super_admin can manage users.
    match /users/{userId} {
      allow read: if request.auth.uid == userId;
      allow list, write: if getRole() == 'super_admin';
    }

    // Classes are readable by all authenticated users, writable by admin/coordinator.
    match /classes/{docId} {
      allow read, list: if request.auth != null;
      allow write: if getRole() in ['super_admin', 'coordinator'];
    }

    // Academic collections for admins and coordinators
    match /students/{docId} {
      allow read, list, write: if getRole() in ['super_admin', 'coordinator'];
    }
    match /teachers/{docId} {
      allow read, list, write: if getRole() in ['super_admin', 'coordinator'];
    }
    match /alumni/{docId} {
      allow read, list, write: if getRole() in ['super_admin', 'coordinator'];
    }
    match /attendances/{docId} {
      allow read, list, write: if getRole() in ['super_admin', 'coordinator'];
    }
    match /teacherAttendances/{docId} {
      allow read, list, write: if getRole() in ['super_admin', 'coordinator'];
    }
    match /exams/{docId} {
      allow read, list, write: if getRole() in ['super_admin', 'coordinator'];
    }
    match /timetables/{docId} {
      allow read, list, write: if getRole() in ['super_admin', 'coordinator'];
    }
    match /families/{docId} {
      allow read, list, write: if getRole() in ['super_admin', 'coordinator'];
    }

    // Financial collections for admins and accountants
    match /fees/{docId} {
      allow read, list, write: if getRole() in ['super_admin', 'accountant'];
    }
    match /expenses/{docId} {
      allow read, list, write: if getRole() in ['super_admin', 'accountant'];
    }

    // Admin-only collections
    match /activityLog/{docId} {
      allow read, list, write: if getRole() == 'super_admin';
    }
     match /sessions/{docId} {
      allow read, list, write: if getRole() == 'super_admin';
    }
    match /branding/{docId} {
      allow read, write: if getRole() == 'super_admin';
    }
    match /Settings/{docId} {
      allow read, write: if getRole() == 'super_admin';
    }
  }
}