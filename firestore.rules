rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to get the user's role from the /users collection
    function getRole(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.role;
    }
    
    // Any authenticated user can read their own user document to get their role.
    // Only super_admins can write to user documents (to change roles).
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write, list: if request.auth != null && getRole(request.auth.uid) == 'super_admin';
    }

    // ACADEMIC & ADMINISTRATIVE COLLECTIONS
    match /{collectionName=**}/_ {
        // This is a placeholder to allow the collections below to work
    }

    match /{collectionName=students|families|classes|teachers|alumni|attendances|exams|timetables}/{docId} {
      allow read, list, write: if request.auth != null && getRole(request.auth.uid) in ['super_admin', 'coordinator'];
    }

    // FINANCIAL COLLECTIONS
    match /{collectionName=fees|expenses|accounts}/{docId} {
      allow read, list, write: if request.auth != null && getRole(request.auth.uid) in ['super_admin', 'accountant'];
    }

    // SUPER_ADMIN ONLY COLLECTIONS
    match /{collectionName=settings|activityLog|sessions|archived}/{docId} {
       allow read, list, write: if request.auth != null && getRole(request.auth.uid) == 'super_admin';
    }
  }
}
